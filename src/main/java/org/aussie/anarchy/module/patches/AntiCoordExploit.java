package org.aussie.anarchy.module.patches;

import org.aussie.anarchy.Anarchy;
import org.aussie.anarchy.module.Module;
import org.aussie.anarchy.util.config.Config;
import org.bukkit.Bukkit;
import org.bukkit.entity.Player;
import org.bukkit.event.EventHandler;
import org.bukkit.event.player.PlayerRespawnEvent;
import org.bukkit.event.player.PlayerTeleportEvent;

import java.awt.*;

public class AntiCoordExploit extends Module {

    @Override
    public boolean isEnabled() {
        return Config.ANTICOORDEXPLOIT;
    }

    @Override
    public Module onEnable() {
        return this;
    }

    @EventHandler
    public void on(PlayerTeleportEvent e) {
        if (isEnabled()) {
            Point p1 = new Point(e.getFrom().getBlockX(), e.getFrom().getBlockZ());
            Point p2 = new Point(e.getTo().getBlockX(), e.getTo().getBlockZ());

            if (p1.distance(p2) > Config.ANTICOORDEXPLOITMINDIST) {
                vanish(e.getPlayer());
                Anarchy.getScheduler().runTaskLater(Anarchy.getPlugin(), () -> unvanish(e.getPlayer()), Config.ANTICOORDEXPLOITTIME);
            }
        }
    }

    @EventHandler
    public void on(PlayerRespawnEvent e) {
        if (isEnabled()) {
            Point p1 = new Point(e.getPlayer().getLocation().getBlockX(), e.getPlayer().getLocation().getBlockZ());
            Point p2 = new Point(e.getRespawnLocation().getBlockX(), e.getRespawnLocation().getBlockZ());

            if (p1.distance(p2) > Config.ANTICOORDEXPLOITMINDIST) {
                vanish(e.getPlayer());
                Anarchy.getScheduler().runTaskLater(Anarchy.getPlugin(), () -> unvanish(e.getPlayer()), Config.ANTICOORDEXPLOITTIME);
            }
        }
    }

    private void vanish(Player p) {
        for (Player onlinePlayer : Bukkit.getOnlinePlayers()) {
            if (!onlinePlayer.equals(p)) {
                onlinePlayer.hidePlayer(Anarchy.getPlugin(), p);
            }
        }
    }

    public void unvanish(Player p) {
        for (Player onlinePlayer : Bukkit.getOnlinePlayers()) {
            if (!onlinePlayer.equals(p)) {
                onlinePlayer.showPlayer(Anarchy.getPlugin(), p);
            }
        }
    }
}
